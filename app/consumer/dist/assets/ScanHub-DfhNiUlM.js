var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,i=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,l=(e,t,s)=>i(e,"symbol"!=typeof t?t+"":t,s),o=(e,t,s)=>new Promise((a,n)=>{var r=e=>{try{l(s.next(e))}catch(t){n(t)}},i=e=>{try{l(s.throw(e))}catch(t){n(t)}},l=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,i);l((s=s.apply(e,t)).next())});import{j as c,u as d,q as u}from"./index-Dr5LwVtT.js";import{r as h,u as m,L as p}from"./react-vendor-DQcjAbTS.js";import{B as _,N as g}from"./zxing-Odk-4kqL.js";import{u as x}from"./useReducedMotion--ddu61Lm.js";import{c as v}from"./trust-score-BT4cMY15.js";import{u as j}from"./useAllergenProfile-DznOho4c.js";const f="_container_5x3ve_1",b="_methodButton_5x3ve_15",y="_methodButtonActive_5x3ve_87",N="_icon_5x3ve_101",w="_label_5x3ve_127";function S({selectedMethod:e,onSelectMethod:t}){const s=[{id:"url",label:"URL",icon:c.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),c.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),description:"Paste a product URL"},{id:"screenshot",label:"Screenshot",icon:c.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),c.jsx("circle",{cx:"9",cy:"9",r:"2"}),c.jsx("path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"})]}),description:"Upload an image"},{id:"barcode",label:"Barcode",icon:c.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("path",{d:"M3 5v14"}),c.jsx("path",{d:"M8 5v14"}),c.jsx("path",{d:"M12 5v14"}),c.jsx("path",{d:"M17 5v14"}),c.jsx("path",{d:"M21 5v14"})]}),description:"Scan a barcode"},{id:"text",label:"Text",icon:c.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("path",{d:"M17 6.1H3"}),c.jsx("path",{d:"M21 12.1H3"}),c.jsx("path",{d:"M15.1 18H3"})]}),description:"Paste text directly"}];return c.jsx("div",{className:f,role:"group","aria-label":"Select input method",children:s.map(s=>c.jsxs("button",{className:`${b} ${e===s.id?y:""}`,onClick:()=>t(s.id),"aria-pressed":e===s.id,"aria-label":`${s.label}: ${s.description}`,children:[c.jsx("div",{className:N,children:s.icon}),c.jsx("span",{className:w,children:s.label})]},s.id))})}let C=class{constructor(){l(this,"reader"),l(this,"videoElement",null),l(this,"isScanning",!1),this.reader=new _}startScanning(e,t){return o(this,null,function*(){if(!this.isScanning){this.videoElement=e,this.isScanning=!0;try{const s=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});e.srcObject=s,e.play(),this.reader.decodeFromVideoDevice(null,e,(e,s)=>{e&&t.onResult({code:e.getText(),format:e.getBarcodeFormat().toString()}),!s||s instanceof g||t.onError(s)})}catch(s){this.isScanning=!1,t.onError(s instanceof Error?s:new Error("Failed to access camera"))}}})}stopScanning(){if(this.isScanning){if(this.reader.reset(),this.videoElement&&this.videoElement.srcObject){this.videoElement.srcObject.getTracks().forEach(e=>e.stop()),this.videoElement.srcObject=null}this.isScanning=!1,this.videoElement=null}}isActive(){return this.isScanning}};const k="_overlay_uw5j6_1",T="_container_uw5j6_29",E="_header_uw5j6_47",P="_title_uw5j6_63",B="_closeButton_uw5j6_77",I="_videoContainer_uw5j6_137",M="_video_uw5j6_137",L="_loading_uw5j6_165",R="_spinner_uw5j6_195",A="_scanFrame_uw5j6_225",$="_corner_uw5j6_247",D="_permissionPrompt_uw5j6_311",F="_cameraIcon_uw5j6_343",O="_permissionTitle_uw5j6_355",U="_permissionDescription_uw5j6_369",W="_permissionActions_uw5j6_385",q="_allowButton_uw5j6_403",z="_error_uw5j6_453",J="_errorIcon_uw5j6_487",K="_errorTitle_uw5j6_499",G="_errorDescription_uw5j6_513",H="_fallbackActions_uw5j6_529",V="_fallbackButton_uw5j6_547",Y="_secondaryButton_uw5j6_595",Z="_instructions_uw5j6_643";function Q({onScan:e,onClose:t,onError:s,onManualInput:a}){const n=h.useRef(null),r=h.useRef(null),[i,l]=h.useState(null),[d,u]=h.useState(!1),[m,p]=h.useState("prompt"),_=()=>o(this,null,function*(){if(!n.current)return;p("requesting"),u(!0);const t=new C;r.current=t,t.startScanning(n.current,{onResult:s=>{e(s.code),t.stopScanning()},onError:e=>{const t=e.message;t.includes("Permission denied")||t.includes("NotAllowedError")||t.includes("permission")?(p("denied"),l("Camera access was denied. Please allow camera access to scan barcodes.")):(p("granted"),l(t)),u(!1),s&&s(t)}});const a=n.current,i=()=>{u(!1),p("granted")};return a.addEventListener("loadedmetadata",i),()=>{t.stopScanning(),a.removeEventListener("loadedmetadata",i)}});h.useEffect(()=>()=>{r.current&&r.current.stopScanning()},[]);const g=()=>{r.current&&r.current.stopScanning(),t()},x=()=>{g(),a&&a()};return c.jsx("div",{className:k,onClick:g,onKeyDown:e=>{"Escape"===e.key&&g()},role:"dialog","aria-label":"Barcode scanner","aria-modal":"true",children:c.jsxs("div",{className:T,onClick:e=>e.stopPropagation(),children:[c.jsxs("div",{className:E,children:[c.jsx("h2",{className:P,children:"Scan Barcode"}),c.jsx("button",{className:B,onClick:g,"aria-label":"Close scanner",children:c.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:c.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),c.jsxs("div",{className:I,children:["prompt"===m&&c.jsxs("div",{className:D,children:[c.jsxs("svg",{className:F,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("path",{d:"M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"}),c.jsx("circle",{cx:"12",cy:"13",r:"4"})]}),c.jsx("h3",{className:O,children:"Camera Access Required"}),c.jsx("p",{className:U,children:"We need access to your camera to scan barcodes. Your camera feed is processed locally and never stored."}),c.jsxs("div",{className:W,children:[c.jsx("button",{className:q,onClick:_,"aria-label":"Allow camera access",children:"Allow Camera Access"}),c.jsx("button",{className:V,onClick:x,"aria-label":"Enter barcode manually",children:"Enter Manually Instead"})]})]}),("requesting"===m||d)&&c.jsxs("div",{className:L,children:[c.jsx("div",{className:R,"aria-label":"Loading camera"}),c.jsx("p",{children:"Starting camera..."})]}),"granted"===m&&!i&&c.jsxs(c.Fragment,{children:[c.jsx("video",{ref:n,className:M,playsInline:!0,muted:!0,"aria-label":"Camera feed for barcode scanning"}),!d&&c.jsxs("div",{className:A,children:[c.jsx("div",{className:$,style:{top:0,left:0}}),c.jsx("div",{className:$,style:{top:0,right:0}}),c.jsx("div",{className:$,style:{bottom:0,left:0}}),c.jsx("div",{className:$,style:{bottom:0,right:0}})]})]}),"denied"===m&&c.jsxs("div",{className:z,role:"alert",children:[c.jsxs("svg",{className:J,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("circle",{cx:"12",cy:"12",r:"10"}),c.jsx("path",{d:"M15 9l-6 6M9 9l6 6"})]}),c.jsx("h3",{className:K,children:"Camera Access Denied"}),c.jsx("p",{className:G,children:i||"Camera access was denied. To scan barcodes, please allow camera access in your browser settings."}),c.jsxs("div",{className:H,children:[c.jsx("button",{className:V,onClick:x,"aria-label":"Enter barcode manually",children:"Enter Barcode Manually"}),c.jsx("button",{className:Y,onClick:_,"aria-label":"Try camera again",children:"Try Again"})]})]}),i&&"granted"===m&&c.jsxs("div",{className:z,role:"alert",children:[c.jsxs("svg",{className:J,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("circle",{cx:"12",cy:"12",r:"10"}),c.jsx("path",{d:"M12 8v4M12 16h.01"})]}),c.jsx("h3",{className:K,children:"Scanner Error"}),c.jsx("p",{className:G,children:i}),c.jsx("div",{className:H,children:c.jsx("button",{className:V,onClick:x,"aria-label":"Enter barcode manually",children:"Enter Manually Instead"})})]})]}),"granted"===m&&!i&&c.jsx("p",{className:Z,children:"Position the barcode within the frame"})]})})}const X="_overlay_160nv_1",ee="_container_160nv_29",te="_title_160nv_47",se="_description_160nv_61",ae="_editorWrapper_160nv_73",ne="_textarea_160nv_81",re="_help_160nv_133",ie="_actions_160nv_145",le="_cancelButton_160nv_157",oe="_confirmButton_160nv_159";function ce({initialText:e,onConfirm:t,onCancel:s,isLoading:a=!1}){const[n,r]=h.useState(e);return c.jsx("div",{className:X,role:"dialog","aria-labelledby":"editor-title","aria-modal":"true",children:c.jsxs("div",{className:`${ee} glass-surface`,children:[c.jsx("h2",{id:"editor-title",className:te,children:"Extracted Text"}),c.jsx("p",{className:se,children:"Review and edit the text extracted from your image before scanning."}),c.jsxs("div",{className:ae,children:[c.jsx("label",{htmlFor:"extracted-text",className:"sr-only",children:"Extracted text content"}),c.jsx("textarea",{id:"extracted-text",className:ne,value:n,onChange:e=>r(e.target.value),rows:12,disabled:a,"aria-describedby":"editor-help"}),c.jsx("p",{id:"editor-help",className:re,children:"Edit the text if needed to improve accuracy"})]}),c.jsxs("div",{className:ie,children:[c.jsx("button",{className:le,onClick:s,disabled:a,"aria-label":"Cancel and go back",children:"Cancel"}),c.jsx("button",{className:oe,onClick:()=>{n.trim()&&t(n)},disabled:!n.trim()||a,"aria-label":"Confirm and scan text",children:a?"Processing...":"Scan This Text"})]})]})})}const de="_container_1e7hb_1",ue="_active_1e7hb_27",he="_complete_1e7hb_37",me="_error_1e7hb_47",pe="_iconWrapper_1e7hb_57",_e="_icon_1e7hb_57",ge="_spectralGlow_1e7hb_93",xe="_progressFill_1e7hb_151",ve="_content_1e7hb_161",je="_label_1e7hb_171",fe="_errorMessage_1e7hb_185",be="_progressBar_1e7hb_199",ye={idle:"Ready to scan",extract:"Extracting content...",checks:"Running policy checks...",verdict:"Calculating verdict...",complete:"Analysis complete",error:"Something went wrong"},Ne={idle:"ðŸ”",extract:"ðŸ“„",checks:"ðŸ”¬",verdict:"âš–ï¸",complete:"âœ…",error:"âš ï¸"};function we({stage:e,error:t}){const s="idle"!==e&&"complete"!==e&&"error"!==e,a="error"===e,n="complete"===e;return c.jsxs("div",{className:`${de} ${s?ue:""} ${a?me:""} ${n?he:""}`,role:a?"alert":"status","aria-live":a?"assertive":"polite","aria-atomic":"true",children:[c.jsxs("div",{className:pe,children:[c.jsx("span",{className:_e,"aria-hidden":"true",children:Ne[e]}),s&&c.jsx("div",{className:ge,"aria-hidden":"true"})]}),c.jsxs("div",{className:ve,children:[c.jsx("p",{className:je,children:ye[e]}),t&&a&&c.jsx("p",{className:fe,children:t}),s&&c.jsx("div",{className:be,"aria-hidden":"true",children:c.jsx("div",{className:xe})})]})]})}const Se={container:"_container_o56g2_1",header:"_header_o56g2_35",icon:"_icon_o56g2_53",title:"_title_o56g2_63",steps:"_steps_o56g2_79",step:"_step_o56g2_79",stepIndicator:"_stepIndicator_o56g2_147",scanningPulse:"_scanningPulse_o56g2_167",statusIcon:"_statusIcon_o56g2_205",stepContent:"_stepContent_o56g2_237",stepLabel:"_stepLabel_o56g2_247",stepEvidence:"_stepEvidence_o56g2_261",stepStatus:"_stepStatus_o56g2_287",evidenceIcon:"_evidenceIcon_o56g2_347",evidenceText:"_evidenceText_o56g2_357",scanLine:"_scanLine_o56g2_371"};function Ce({steps:e,onComplete:t,isActive:s}){const[a,n]=h.useState(-1),[r,i]=h.useState([]),l=x(),o=h.useRef(),d=h.useRef(null);return h.useEffect(()=>{s&&d.current,0},[s]),h.useEffect(()=>{if(!s)return n(-1),void i([]);const a=()=>{n(s=>{const n=s+1;if(n>=e.length)return t&&setTimeout(t,300),s;i(e.slice(0,n+1));const r=l?150:250+200*Math.random();return o.current=setTimeout(a,r),n})};return o.current=setTimeout(a,300),()=>{o.current&&clearTimeout(o.current)}},[s,e,t,l]),s?c.jsxs("div",{ref:d,className:Se.container,role:"status","aria-live":"polite","data-modal":"true","data-testid":"spectral-scan-card",children:[c.jsxs("div",{className:Se.header,children:[c.jsx("span",{className:Se.icon,children:"ðŸ”¬"}),c.jsx("h3",{className:Se.title,children:"Forensic Analysis"})]}),c.jsxs("div",{className:Se.steps,children:[0===r.length&&c.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#14B8A6",fontSize:"16px",fontWeight:500},children:"Initializing scan..."}),r.map((e,t)=>{const s=t===a&&"scanning"===e.status,n=t<a||["found","clear","skipped"].includes(e.status);return c.jsxs("div",{className:`${Se.step} ${s?Se.stepScanning:""} ${n?Se.stepComplete:""}`,"data-status":e.status,children:[c.jsxs("div",{className:Se.stepIndicator,children:["scanning"===e.status&&c.jsx("div",{className:Se.scanningPulse,"aria-hidden":"true"}),"found"===e.status&&c.jsx("span",{className:Se.statusIcon,"aria-label":"Issue found",children:"âš ï¸"}),"clear"===e.status&&c.jsx("span",{className:Se.statusIcon,"aria-label":"Clear",children:"âœ“"}),"skipped"===e.status&&c.jsx("span",{className:Se.statusIcon,"aria-label":"Skipped",children:"â€”"})]}),c.jsxs("div",{className:Se.stepContent,children:[c.jsx("div",{className:Se.stepLabel,children:e.label}),e.evidence&&n&&c.jsxs("div",{className:Se.stepEvidence,children:[c.jsx("span",{className:Se.evidenceIcon,children:"ðŸ“‹"}),c.jsx("span",{className:Se.evidenceText,children:e.evidence})]}),"scanning"===e.status&&c.jsx("div",{className:Se.stepStatus,children:"Analyzing..."})]}),!l&&s&&c.jsx("div",{className:Se.scanLine,"aria-hidden":"true"})]},e.id)})]})]}):null}const ke="off_barcode_";let Te=0;function Ee(e){return o(this,null,function*(){var t,s,a,n,r,i;const l=function(e){try{const t=localStorage.getItem(`${ke}${e}`);if(!t)return null;const{data:s,timestamp:a}=JSON.parse(t);return Date.now()-a>6048e5?(localStorage.removeItem(`${ke}${e}`),null):s}catch(t){return null}}(e);if(l)return l;try{const l=new AbortController,c=setTimeout(()=>l.abort(),3e3),d=yield function(e){return o(this,null,function*(){const t=Date.now()-Te;return t<600&&(yield new Promise(e=>setTimeout(e,600-t))),Te=Date.now(),fetch(e)})}(`https://world.openfoodfacts.org/api/v2/product/${e}.json`);if(clearTimeout(c),!d.ok){if(429===d.status)throw new Error("Rate limit exceeded. Please try again in a moment.");throw new Error(`API request failed: ${d.statusText}`)}const u=yield d.json();if(1!==u.status||!u.product)return null;const h=u.product,m={name:h.product_name||"Unknown Product",ingredients:h.ingredients_text,allergens:(null==(t=h.allergens_tags)?void 0:t.map(e=>e.replace("en:","").replace(/-/g," ")))||[],nutrition:h.nutriments?{energy:null==(s=h.nutriments["energy-kcal_100g"])?void 0:s.toString(),fat:null==(a=h.nutriments.fat_100g)?void 0:a.toString(),carbohydrates:null==(n=h.nutriments.carbohydrates_100g)?void 0:n.toString(),protein:null==(r=h.nutriments.proteins_100g)?void 0:r.toString(),salt:null==(i=h.nutriments.salt_100g)?void 0:i.toString()}:void 0,imageUrl:h.image_url};return function(e,t){try{localStorage.setItem(`${ke}${e}`,JSON.stringify({data:t,timestamp:Date.now()}))}catch(s){}}(e,m),m}catch(c){if(c instanceof Error&&"AbortError"===c.name)throw new Error("Request timed out. Please try again.");throw c}})}function Pe(e){return o(this,null,function*(){try{const t=yield function(e,t=1920,s=1080){return o(this,null,function*(){return new Promise((a,n)=>{const r=new Image;r.onload=()=>{let{width:e,height:i}=r;if(e>t||i>s){const a=Math.min(t/e,s/i);e=Math.floor(e*a),i=Math.floor(i*a)}const l=document.createElement("canvas");l.width=e,l.height=i;const o=l.getContext("2d");o?(o.drawImage(r,0,0,e,i),a(l.toDataURL("image/jpeg",.9))):n(new Error("Failed to get canvas context"))},r.onerror=()=>{n(new Error("Failed to load image"))},r.src=e})})}(e),s=yield fetch("/v1/consumer/ocr",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_data:t})});if(!s.ok){const e=yield s.json().catch(()=>({message:s.statusText}));throw new Error(e.message||"OCR processing failed")}return yield s.json()}catch(t){if(t instanceof Error)throw t;throw new Error("Failed to extract text from image")}})}const Be=new class{constructor(){l(this,"cache",new Map),l(this,"pendingRequests",new Map),l(this,"defaultTTL",3e5)}getCacheKey(e,t){return`${(null==t?void 0:t.method)||"GET"}:${e}:${(null==t?void 0:t.body)?JSON.stringify(t.body):""}`}isValid(e){return Date.now()<e.expiresAt}get(e,t){const s=this.getCacheKey(e,t),a=this.cache.get(s);return a&&this.isValid(a)?a.data:(a&&this.cache.delete(s),null)}set(e,t,s,a){const n=this.getCacheKey(e,s),r=Date.now()+(a||this.defaultTTL);this.cache.set(n,{data:t,timestamp:Date.now(),expiresAt:r})}clear(e,t){const s=this.getCacheKey(e,t);this.cache.delete(s)}clearAll(){this.cache.clear()}dedupe(e,t,s){return o(this,null,function*(){const a=this.getCacheKey(e,s),n=this.pendingRequests.get(a);if(n)return n.promise;const r=t().then(e=>(this.pendingRequests.delete(a),e)).catch(e=>{throw this.pendingRequests.delete(a),e});return this.pendingRequests.set(a,{promise:r,timestamp:Date.now()}),r})}fetch(e,t,s){return o(this,null,function*(){const a=this.get(e,t);return null!==a?a:this.dedupe(e,()=>o(this,null,function*(){const a=yield fetch(e,t);if(!a.ok)throw new Error(`Request failed: ${a.statusText}`);const n=yield a.json();return this.set(e,n,t,s),n}),t)})}getStats(){return{cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size}}};function Ie(e){const t=e.split("\n").map(e=>e.trim()).filter(Boolean);if(0===t.length)return"Text Scan";const s=t[0];return s.length>50?s.substring(0,47)+"...":s}function Me(e){const{method:t,urlInput:s,textInput:a,barcodeCode:n,extractedText:r,apiProductName:i,pageTitle:l}=e;if(i&&i.trim())return i.trim();if(l&&l.trim()&&"url"===t)return l.trim();switch(t){case"url":return s?function(e){try{const t=new URL(e),s=t.hostname.replace("www.",""),a=t.pathname.split("/").filter(Boolean),n=["product","products","item","items","p","i","menu","food","shop"],r=a.find(e=>e.length>3&&!n.includes(e.toLowerCase()));return r?r.replace(/[-_]/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "):`Product from ${s}`}catch(t){return"Web Product"}}(s):"Web Product";case"text":return a?Ie(a):"Text Scan";case"screenshot":return r?Ie(r):"Screenshot Scan";case"barcode":return n?`Barcode ${n}`:"Barcode Scan";default:return"Unknown Item"}}const Le="_container_1p570_1",Re="_title_1p570_11",Ae="_description_1p570_27",$e="_inputArea_1p570_43",De="_inputGroup_1p570_53",Fe="_label_1p570_61",Oe="_input_1p570_43",Ue="_textarea_1p570_79",We="_fileInput_1p570_137",qe="_help_1p570_179",ze="_error_1p570_193",Je="_preview_1p570_213",Ke="_previewImage_1p570_227",Ge="_scanButton_1p570_253",He="_allergenBadge_1p570_353",Ve="_allergenIcon_1p570_403",Ye="_allergenText_1p570_413",Ze="_startScanButton_1p570_423",Qe="_loadingBarcode_1p570_491",Xe="_spinner_1p570_509",et="_barcodeError_1p570_549",tt="_retryButton_1p570_591",st="_barcodeResult_1p570_635",at="_productImage_1p570_655",nt="_productInfo_1p570_673",rt="_productName_1p570_681",it="_productAllergens_1p570_695",lt="_productSource_1p570_715",ot="_changeBarcodeButton_1p570_745",ct="_loadingOcr_1p570_793",dt="_ocrError_1p570_823",ut="_extractedTextPreview_1p570_875",ht="_extractedLabel_1p570_895",mt="_editTextButton_1p570_925",pt="_primaryInput_1p570_995",_t="_urlInputLarge_1p570_1009",gt="_scanButtonLarge_1p570_1057",xt="_demoSection_1p570_1127",vt="_demoButton_1p570_1139",jt="_divider_1p570_1195",ft="_dividerText_1p570_1227",bt="_privacyNote_1p570_1253",yt="_privacyIcon_1p570_1277",Nt="_bottomNav_1p570_1287",wt="_navItem_1p570_1319",St="_navItemActive_1p570_1373",Ct="_navIcon_1p570_1407",kt="_navBadge_1p570_1417",Tt="_progressSection_1p570_1505",Et="_errorActions_1p570_1515",Pt="_fallbackButton_1p570_1531";const Bt=["localhost","127.0.0.1","0.0.0.0","internal","admin"];function It(){const e=m(),l=d(),{getAllergenCount:_,getAllAllergens:g}=j(),[x,f]=h.useState(null),[b,y]=h.useState(""),[N,w]=h.useState(""),[,C]=h.useState(null),[k,T]=h.useState(null),[E,P]=h.useState(""),[B,I]=h.useState(""),[M,L]=h.useState(!1),[R,A]=h.useState(!1),[$,D]=h.useState(null),[F,O]=h.useState(null),[U,W]=h.useState(null),[q,z]=h.useState(!1),[J,K]=h.useState(!1),[G,H]=h.useState(null),[V,Y]=h.useState(null),[Z,X]=h.useState(!1),[ee,te]=h.useState("idle"),[se,ae]=h.useState(void 0),[ne,re]=h.useState(!1),[ie,le]=h.useState([]),[oe,de]=h.useState(!1),ue=e=>{if(!e.trim())return P("That URL doesn't look right. Try pasting a product page link."),!1;try{const t=new URL(e);if(!["http:","https:"].includes(t.protocol))return P("That URL doesn't look right. Try pasting a product page link."),!1;const s=t.hostname.toLowerCase();return Bt.some(e=>s.includes(e))?(P("We can't access that site. Try a screenshot instead."),!1):(P(""),!0)}catch(t){return P("That URL doesn't look right. Try pasting a product page link."),!1}},he=e=>{if(!e.trim())return I("Text is required"),!1;const t=new Blob([e]).size;return t>10240?(I(`Text is too large (${Math.round(t/1024)}KB). Maximum is 10KB.`),!1):(I(""),!0)},me=()=>o(this,null,function*(){let o=!1,c="";switch(x){case"url":o=ue(b),c=b;break;case"text":o=he(N),c=N;break;case"screenshot":G?(o=!0,c=G):o=!1;break;case"barcode":if(!$)return void A(!0);o=!0,c=`Product: ${$.name}\n`,$.ingredients&&(c+=`Ingredients: ${$.ingredients}\n`),$.allergens&&$.allergens.length>0&&(c+=`Allergens: ${$.allergens.join(", ")}\n`)}if(o&&x){L(!0),ae(void 0),te("extract"),de(!1);try{const o=g();if(!l)return u({inputType:x,inputData:c,locale:"en-US",allergenProfile:o.length>0?o:void 0}),alert("Connection issue. Your scan will resume when you're back online."),f(null),y(""),w(""),C(null),T(null),D(null),void te("idle");yield new Promise(e=>setTimeout(e,300));const d=yield Be.fetch("/v1/consumer/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input_type:x,input_data:c,locale:"en-US",allergen_profile:o.length>0?o:void 0})},12e4),h=function(e,t){var s,a,n,r;const i=[];"screenshot"===e&&i.push({id:"ocr",label:"OCR Label Extraction (MCP)",status:"clear",evidence:(null==(s=t.product_info)?void 0:s.scanned_text_preview)?`Extracted: "${t.product_info.scanned_text_preview.substring(0,50)}..."`:"Text extracted successfully"});const l=t.badges.filter(e=>e.label.toLowerCase().includes("allergen"));i.push({id:"allergens",label:"Allergen Detection",status:l.length>0?"found":"clear",evidence:l.length>0?`Found: ${l.map(e=>e.explanation).join(", ")}`:"No allergens detected"});const o=t.badges.filter(e=>e.label.toLowerCase().includes("banned")||e.label.toLowerCase().includes("claim")),c=t.reasons.filter(e=>e.transform.includes("banned")||e.transform.includes("claim")),d=o.length>0||c.length>0;i.push({id:"banned_claims",label:"Banned Claims Check",status:d?"found":"clear",evidence:d?(null==(a=o[0])?void 0:a.explanation)||(null==(n=c[0])?void 0:n.why)||"Prohibited health claim detected":"No banned claims found"});const u=t.reasons.filter(e=>e.transform.includes("disclaimer")||e.transform.includes("rewrite"));i.push({id:"disclaimers",label:"Disclaimer Verification",status:u.length>0?"found":"clear",evidence:u.length>0?"Missing required disclaimers":"All disclaimers present"});const h=t.reasons.filter(e=>e.transform.includes("pii")||e.transform.includes("redact"));i.push({id:"pii",label:"PII Redaction",status:h.length>0?"found":"clear",evidence:h.length>0?"Personal information detected and redacted":"No PII detected"});const m=t.badges.filter(e=>e.label.toLowerCase().includes("recall"));i.push({id:"recalls",label:"Recall Database Lookup (MCP)",status:m.length>0?"found":"clear",evidence:m.length>0?"Product recall found":"No recalls found"});const p=t.badges.filter(e=>e.label.toLowerCase().includes("weasel"));return p.length>0&&i.push({id:"weasel",label:"Marketing Language Analysis",status:"found",evidence:(null==(r=p[0])?void 0:r.explanation)||"Vague marketing language detected"}),i}(x,d),m=h.map(e=>{return l=((e,t)=>{for(var s in t||(t={}))n.call(t,s)&&i(e,s,t[s]);if(a)for(var s of a(t))r.call(t,s)&&i(e,s,t[s]);return e})({},e),t(l,s({status:"scanning"}));var l});0,le(m),de(!0),te("checks"),yield new Promise(e=>setTimeout(e,400*h.length+500)),le(h),te("verdict"),yield new Promise(e=>setTimeout(e,300));const p=v({bannedClaimsCount:0,hasRecall:!1,userAllergensCount:0,weaselWordDensity:0}).breakdown,_=function(e,t,s,a,n,r,i){const l=Me({method:e,urlInput:t,textInput:s,barcodeCode:r||void 0,extractedText:a||void 0,apiProductName:null==i?void 0:i.product_name});let o,c,d;switch(e){case"url":try{d=new URL(t).hostname}catch(u){d="web"}o=null==i?void 0:i.brand,c=null==i?void 0:i.category;break;case"barcode":o=null==i?void 0:i.brand,c=null==i?void 0:i.category,d=r?`UPC ${r}`:"barcode scan";break;case"screenshot":o=null==i?void 0:i.brand,c=null==i?void 0:i.category,d="photo";break;case"text":o=null==i?void 0:i.brand,c=null==i?void 0:i.category,d="manual entry"}return{name:l,brand:o,category:c,sourceType:e,sourceLabel:d}}(x,b,N,G,0,F,d.product_info),j={productIdentity:_,product_info:d.product_info,trust_score:d.trust_score,verdict:d.verdict,badges:d.badges,reasons:d.reasons,suggestions:d.suggestions,correlation_id:d.correlation_id,breakdown:p};sessionStorage.setItem("scanResults",JSON.stringify(j)),te("complete"),yield new Promise(e=>setTimeout(e,500)),L(!1),e("/results")}catch(d){const e=d instanceof Error?d.message:"Failed to scan. Please try again.";ae(e),te("error"),L(!1)}}}),pe=_();return c.jsxs(c.Fragment,{children:[R&&c.jsx(Q,{onScan:e=>o(this,null,function*(){A(!1),O(e),z(!0),W(null),re(!1);try{const t=yield Ee(e);if(!t)return void W("Product not found - Try manual input");D(t)}catch(t){const e=t instanceof Error?t.message:"Failed to lookup barcode";W(e)}finally{z(!1)}}),onClose:()=>{A(!1),re(!1)},onError:e=>{e.toLowerCase().includes("permission")||e.toLowerCase().includes("denied")?(re(!0),W("Camera access denied. Please enable camera permissions in your browser settings, or try another scan method.")):W(e)},onManualInput:()=>{A(!1),f("text"),re(!1)}}),Z&&G&&c.jsx(ce,{initialText:G,onConfirm:e=>{H(e),X(!1)},onCancel:()=>{X(!1),C(null),T(null),H(null)},isLoading:M}),c.jsxs("div",{className:Le,children:[c.jsx("h1",{className:Re,children:"Scan Food Items"}),c.jsx("p",{className:Ae,children:"Paste a product URL or choose another scan method below"}),(M||"idle"!==ee)&&c.jsx("div",{className:Tt,children:c.jsx(we,{stage:ee,error:se})}),oe&&ie.length>0&&c.jsx("div",{"data-testid":"spectral-scan-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:99999,display:"grid",placeItems:"center",background:"rgba(0, 0, 0, 0.85)",backdropFilter:"blur(8px)"},children:c.jsx(Ce,{steps:ie,isActive:M,onComplete:()=>{}})}),c.jsxs("div",{className:pt,children:[c.jsx("input",{type:"url",className:_t,placeholder:"Paste a Swiggy/Zomato/Instamart product or menu URLâ€¦",value:b,onChange:e=>y(e.target.value),onKeyDown:e=>{"Enter"===e.key&&b.trim()&&(f("url"),me())},"aria-label":"Product URL"}),c.jsx("button",{className:gt,onClick:()=>{f("url"),me()},disabled:!b.trim()||M,children:M?"Scanning...":"Scan"})]}),c.jsx("div",{className:xt,children:c.jsx("button",{onClick:()=>{sessionStorage.setItem("scanResults",JSON.stringify({productIdentity:{name:"Immunity Booster Juice",brand:"HealthyLife",category:"Beverages",sourceType:"text",sourceLabel:"demo"},product_info:{product_name:"Immunity Booster Juice",brand:"HealthyLife",category:"Beverages",claims:["Boosts Immunity","Detox Formula","Superfood Blend"]},trust_score:45,verdict:{label:"caution",color:"#F59E0B",icon:"âš ï¸",explanation:"Multiple banned health claims detected. Product contains vague marketing language."},badges:[{kind:"danger",label:"Banned Claim",explanation:'"Boosts Immunity" is a prohibited health claim',source:"https://example.com/rules/banned-claims"},{kind:"warn",label:"Weasel Words",explanation:'Contains vague marketing language like "may help"'}],reasons:[],breakdown:{baseScore:90,bannedClaimsDeduction:-30,recallDeduction:0,allergenDeduction:0,weaselWordDeduction:-15,cleanBonus:0,finalScore:45}})),e("/results")},className:vt,children:"âœ¨ Try Demo"})}),pe>0&&c.jsxs(p,{to:"/settings",className:He,children:[c.jsx("span",{className:Ve,children:"ðŸ›¡ï¸"}),c.jsxs("span",{className:Ye,children:[pe," allergen",1!==pe?"s":""," configured"]})]}),c.jsx("div",{className:jt,children:c.jsx("span",{className:ft,children:"Or choose another method"})}),c.jsx(S,{selectedMethod:x,onSelectMethod:f}),x&&c.jsxs("div",{className:`${$e} glass-surface`,children:["url"===x&&c.jsxs("div",{className:De,children:[c.jsx("label",{htmlFor:"url-input",className:Fe,children:"Enter URL"}),c.jsx("input",{id:"url-input",type:"url",className:Oe,placeholder:"https://example.com/product",value:b,onChange:e=>{y(e.target.value),E&&ue(e.target.value)},onBlur:()=>b&&ue(b),"aria-invalid":E?"true":"false","aria-describedby":E?"url-error":void 0}),E&&c.jsx("p",{id:"url-error",className:ze,role:"alert",children:E})]}),"screenshot"===x&&c.jsxs("div",{className:De,children:[c.jsx("label",{htmlFor:"screenshot-input",className:Fe,children:"Upload Screenshot"}),c.jsx("input",{id:"screenshot-input",type:"file",accept:"image/jpeg,image/png,image/webp",className:We,onChange:e=>o(this,null,function*(){var t;const s=null==(t=e.target.files)?void 0:t[0];if(!s)return;const a=function(e){return["image/jpeg","image/png","image/webp"].includes(e.type)?e.size>5242880?{valid:!1,error:`File too large (${(e.size/1024/1024).toFixed(1)}MB). Maximum size is 5MB.`}:{valid:!0}:{valid:!1,error:"Invalid file type. Please upload JPEG, PNG, or WebP image."}}(s);if(!a.valid)return void Y(a.error||"Couldn't read that image. Try a clearer photo or paste text.");C(s),Y(null),H(null);const n=new FileReader;n.onloadend=()=>o(this,null,function*(){const e=n.result;T(e),K(!0),te("extract");try{const t=yield Pe(e);if(!t.text||0===t.text.trim().length)return Y("Couldn't read that image. Try a clearer photo or paste text."),void te("error");H(t.text),X(!0),te("idle")}catch(t){const e=t instanceof Error?t.message:"Couldn't read that image. Try a clearer photo or paste text.";Y(e),te("error")}finally{K(!1)}}),n.readAsDataURL(s)}),"aria-describedby":"screenshot-help",disabled:J}),c.jsx("p",{id:"screenshot-help",className:qe,children:"Accepted formats: JPG, PNG, WebP (max 5MB)"}),J&&c.jsxs("div",{className:ct,children:[c.jsx("div",{className:Xe,"aria-label":"Extracting text from image"}),c.jsx("p",{children:"Extracting text from image..."})]}),V&&c.jsxs("div",{className:dt,role:"alert",children:[c.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("circle",{cx:"12",cy:"12",r:"10"}),c.jsx("path",{d:"M12 8v4M12 16h.01"})]}),c.jsx("p",{children:V})]}),k&&!J&&c.jsxs("div",{className:Je,children:[c.jsx("img",{src:k,alt:"Screenshot preview",className:Ke}),G&&c.jsxs("div",{className:ut,children:[c.jsxs("p",{className:ht,children:[c.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:c.jsx("path",{d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Text extracted successfully"]}),c.jsx("button",{className:mt,onClick:()=>X(!0),"aria-label":"Edit extracted text",children:"Edit Text"})]})]})]}),"text"===x&&c.jsxs("div",{className:De,children:[c.jsx("label",{htmlFor:"text-input",className:Fe,children:"Paste Text"}),c.jsx("textarea",{id:"text-input",className:Ue,placeholder:"Paste product description, ingredients list, or menu text here...",value:N,onChange:e=>{w(e.target.value),B&&he(e.target.value)},onBlur:()=>N&&he(N),rows:8,"aria-invalid":B?"true":"false","aria-describedby":B?"text-error":"text-help"}),c.jsx("p",{id:"text-help",className:qe,children:"Maximum 10KB of text"}),B&&c.jsx("p",{id:"text-error",className:ze,role:"alert",children:B})]}),"barcode"===x&&c.jsxs("div",{className:De,children:[!$&&!U&&!q&&c.jsxs("button",{className:Ze,onClick:()=>A(!0),"aria-label":"Start barcode scanner",children:[c.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("rect",{x:"2",y:"2",width:"20",height:"20",rx:"2"}),c.jsx("path",{d:"M8 2v20M16 2v20"})]}),c.jsx("span",{children:"Start Camera"})]}),q&&c.jsxs("div",{className:Qe,children:[c.jsx("div",{className:Xe,"aria-label":"Loading product data"}),c.jsx("p",{children:"Looking up product..."})]}),U&&c.jsxs("div",{className:et,role:"alert",children:[c.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[c.jsx("circle",{cx:"12",cy:"12",r:"10"}),c.jsx("path",{d:"M12 8v4M12 16h.01"})]}),c.jsx("p",{children:U}),c.jsxs("div",{className:Et,children:[!ne&&c.jsx("button",{className:tt,onClick:()=>{W(null),A(!0)},children:"Try Again"}),ne&&c.jsxs(c.Fragment,{children:[c.jsx("button",{className:Pt,onClick:()=>{W(null),D(null),f("screenshot")},children:"Use Screenshot Instead"}),c.jsx("button",{className:Pt,onClick:()=>{W(null),D(null),f("text")},children:"Paste Text Instead"})]})]})]}),$&&c.jsxs("div",{className:st,children:[$.imageUrl&&c.jsx("img",{src:$.imageUrl,alt:$.name,className:at}),c.jsxs("div",{className:nt,children:[c.jsx("h3",{className:rt,children:$.name}),$.allergens&&$.allergens.length>0&&c.jsxs("p",{className:it,children:[c.jsx("strong",{children:"Allergens:"})," ",$.allergens.join(", ")]}),c.jsxs("p",{className:lt,children:["Data from ",c.jsx("a",{href:"https://world.openfoodfacts.org",target:"_blank",rel:"noopener noreferrer",children:"Open Food Facts"})]})]}),c.jsx("button",{className:ot,onClick:()=>{D(null),A(!0)},"aria-label":"Scan different barcode",children:"Scan Different"})]})]}),c.jsx("button",{className:Ge,onClick:me,disabled:!(()=>{switch(x){case"url":return""!==b.trim()&&""===E;case"text":return""!==N.trim()&&""===B;case"screenshot":return null!==G&&!J;case"barcode":return null!==$;default:return!1}})()||M,"aria-label":"Scan food item",children:M?"Scanning...":"Scan"})]}),c.jsxs("div",{className:bt,children:[c.jsx("span",{className:yt,children:"ðŸ”’"}),c.jsx("span",{children:"Processed locally by default. Saved only if you choose."})]}),c.jsxs("nav",{className:Nt,"aria-label":"Main navigation",children:[c.jsxs(p,{to:"/scan",className:`${wt} ${St}`,"aria-current":"page",children:[c.jsx("span",{className:Ct,children:"ðŸ”"}),c.jsx("span",{children:"Scan"})]}),c.jsxs(p,{to:"/history",className:wt,children:[c.jsx("span",{className:Ct,children:"ðŸ“œ"}),c.jsx("span",{children:"History"})]}),c.jsxs(p,{to:"/settings",className:wt,children:[c.jsx("span",{className:Ct,children:"âš™ï¸"}),c.jsx("span",{children:"Settings"}),pe>0&&c.jsx("span",{className:kt,children:pe})]})]})]})]})}export{It as default};
